<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>UTM Drone Simulator</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
         
    const {mapToNewObject} = require("@perpk/json-xform");
    <link rel="stylesheet" type="text/css" href="style.css" />
</head>

<body>
    <div class="wrapper">
        <div class="box a">
            <div id="title" name="title" class="title">UTM Data Viewer</div>
                <label id="labelclient" for="client" class="block_label">Client ID</label>
                <input type="text" name="client" id="client" class="block" onkeyup="saveCredentials()" placeholder="Client ID">
                <label id="labelsecret" for="secret" class="block_label">Client Secret</label>
                <input type="text" name="secret" class="block" id="secret" onkeyup="saveCredentials()" placeholder="Client Secret">
                <button id="authenticate" class="button_half" onclick="authServer()">Authenticate</button>
                <label id="labelbearer" for="bearer"class="block_label" >Bearer Token</label>
            <input type="text" name="bearer" id="bearer" class="block" onkeyup="setTokenManually()" placeholder="Bearer Token">
            
        </div>
        <div class="b">
            <div id="map" ></div>
            <div id="distance" class="distance-container"></div>
        </div>
        <div class="box c">
            <input type="file" id="file-input" /> 
            <pre id="file-content"></pre>   

            <button id="convert" onclick="convert()" class="block">Convert & Load AoRs</button>
     
        <div class="modallink" id="modallink" name="modallink">
            <a href="#demo-modal">Info</a>
        </div>
            
        </div>
        <div class="box d">
            <input type="text" name="geojson" id="geojson" class="block" placeholder="ZONE GEOJSON" onkeyup="loadJSONZone()"> 

        </div>
      </div>

    <div class="modal" id="demo-modal" hidden>
        <div class="modal__content">
        <b>UTM Data Viewer</b>
        </br></br>
        (*) Connected to NBD-UTM instance. https://smartsis-airlabs.utm-labs-frequentis.com/
        </br></br>
        (*) Alert Subscriptions are needed for alert ack
        </br></br>
        (*) OP Subscriptions are needed fo close
        </br></br>
        (*) Note: Altitude is the "middle value". Uncertainity of 10m is added via the according computeOP call.
        </br></br>
        (*) Note: Click the "rogue" button again to send the drone back to the nominal flight path.
        </br></br>
        (*) Note: URL parameter "?debug" enables a bit more client console logging.
        </br></br>
        (*) Note: URL parameter "?loadjson" enables a field to directly load a zone.
        </br></br>
        (*) Sources at: https://github.com/moe01324/utmsim
        </br></br>
        (*) version 21.12.2022
        </br></br>
   
        <a href="#" class="modal__close">&times;</a>
    
    </div>
    <script>
        function readSingleFile(e) {
        var file = e.target.files[0];
        if (!file) {
            return;
        }
        var reader = new FileReader();
        reader.onload = function(e) {
            var contents = e.target.result;
            displayContents(contents);
        };
        reader.readAsText(file);
        }

        function displayContents(contents) {

        var aor = contents;
        convert(aor);

        //var element = document.getElementById('file-content');
        //element.textContent = contents;
        }

        document.getElementById('file-input')
        .addEventListener('change', readSingleFile, false);

        var token = "";
        var access_token = "";
        var opID = "";
        var opsaved;
        var landed = 0;
        var pathnumber = 0;
        var altitude = 1;

        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const debug = urlParams.has('debug');
        const loadjson = urlParams.has('loadjson');

        var rogueActiveUp = false;
        var roguevalueUp = 0;
        var rogueActiveRight = false;
        var roguevalueRight = 0;

        // access token from https://www.mapbox.com/ - free
        mapboxgl.accessToken = 'pk.eyJ1IjoibW9lMDEzMjUiLCJhIjoiY2wwbzlxcTVpMGV1MzNvbnRmMmNlOWdzayJ9.YbJY5mSL7Xrymf8k24Sfcg';

        var utmcenterlat = 48.19908;
        var utmcenterlng = 16.4138;

        if(localStorage.getItem('utmcenterlat')){
            utmcenterlat = localStorage.getItem('utmcenterlat');
            utmcenterlng = localStorage.getItem('utmcenterlng');
          }

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [utmcenterlng, utmcenterlat],
            zoom: 12,
            //style: 'mapbox://styles/mapbox/light-v11',
            pitch: 45,
            //bearing: -17.6,
            container: 'map',
            antialias: true
        }
        );

        // GeoJSON object to hold our measurement features
        const geojson = {
            'type': 'FeatureCollection',
            'features': []
        };

        const geojsonzone = {
            'type': 'FeatureCollection',
            'features': []
        };

        map.on('style.load', () => {
            // Insert the layer beneath any symbol layer.
            const layers = map.getStyle().layers;
            const labelLayerId = layers.find(
            (layer) => layer.type === 'symbol' && layer.layout['text-field']
            ).id;
            
            // The 'building' layer in the Mapbox Streets
            // vector tileset contains building height data
            // from OpenStreetMap.
            map.addLayer(
            {
            'id': 'add-3d-buildings',
            'source': 'composite',
            'source-layer': 'building',
            'filter': ['==', 'extrude', 'true'],
            'type': 'fill-extrusion',
            'minzoom': 15,
            'paint': {
            'fill-extrusion-color': '#aaa',
            
            // Use an 'interpolate' expression to
            // add a smooth transition effect to
            // the buildings as the user zooms in.
            'fill-extrusion-height': [
            'interpolate',
            ['linear'],
            ['zoom'],
            15,
            0,
            15.05,
            ['get', 'height']
            ],
            'fill-extrusion-base': [
            'interpolate',
            ['linear'],
            ['zoom'],
            15,
            0,
            15.05,
            ['get', 'min_height']
            ],
            'fill-extrusion-opacity': 0.6
            }
            },
            labelLayerId
            );
        });

        map.on('load', () => {

            map.addSource('geojsonzone', {
            'type': 'geojson',
            /*
             * Each feature in this GeoJSON file contains values for
             * `properties.height`, `properties.base_height`,
             * and `properties.color`.
             * In `addLayer` you will use expressions to set the new
             * layer's paint properties based on these values.
             */
            'data': geojsonzone
            });
            map.addLayer({
                'id': 'room-extrusion',
                'type': 'fill-extrusion',
                'source': 'geojsonzone',
                'paint': {
                    // Get the `fill-extrusion-color` from the source `color` property.
                    'fill-extrusion-color': "orange",

                    // Get `fill-extrusion-height` from the source `height` property.
                    'fill-extrusion-height': 999,

                    // Get `fill-extrusion-base` from the source `base_height` property.
                    'fill-extrusion-base': 333,

                    // Make extrusions slightly opaque to see through indoor walls.
                    'fill-extrusion-opacity': 0.5
                }
            });

            map.on('click', (e) => {
                const center = map.getCenter(); map.getCenter();
                localStorage.utmcenterlat = center.lat;
                localStorage.utmcenterlng = center.lng;
                enableSim();               
            }
            );
        }
        );

        function showInfo() {
            document.getElementById("info").hidden = !document.getElementById("info").hidden;
            
        }

        function convert(aor) {
           
            const obj = JSON.parse(aor);
            bo = new Object();
            bo.type = "FeatureCollection";
            bo.features = [{
                "type": "Feature", 
                "geometry": obj.geometry,
                "properties": {
                "minimumAltitudeInMeters": obj.minimumAltitudeInMeters, 
                "maximumAltitudeInMeters": obj.maximumAltitudeInMeters, 
                "name": obj.name
                }
            }];
          

            console.log(bo);

        }

        function authServer() {
            credentials = new Object();
            credentials.client = document.getElementById("client").value;
            credentials.secret = (document.getElementById("secret").value);

            (async () => {
                const rawResponse = await fetch('/authutm', {
                    method: 'POST',
                    body: JSON.stringify(credentials),
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                }
                );
                token = await rawResponse.json();
                if (debug) {
                    console.log(token);
                }
                setToken(token.access_token);
            }
            )();
        }

        function loadJSONZone() {
            if (document.getElementById("geojson").value !== "" ) {


                var geo = document.getElementById("geojson").value;
   
                const obj = JSON.parse(geo);



                map.getSource('geojsonzone').setData(obj);
            }
   
        }


        function enableSim() {      
            saveCredentials();
        }

        function saveCredentials() {
            localStorage.utmclient = document.getElementById("client").value;
            localStorage.utmsecret = document.getElementById("secret").value;
     
        }

        function setToken(token) {
            access_token = token;
            document.getElementById("bearer").value = token;

        }

        function setTokenManually() {
            access_token = document.getElementById("bearer").value;
        }

        const UUIDGeneratorBrowser = () =>
            ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                (
                    c ^
                    (crypto.getRandomValues(new Uint8Array(1))[0] & (15 >> (c / 4)))
                ).toString(16)
            );

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

    </script>

</body>

</html>
